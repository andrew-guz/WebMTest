<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Live WebM Stream</title>
</head>

<body>
    <video id="video" autoplay muted playsinline controls width="640" height="480"></video>
    <script>
        const video = document.getElementById("video");
        const ms = new MediaSource();
        video.src = URL.createObjectURL(ms);

        let sourceBuffer;
        const queue = [];
        let started = false; // Ñ„Ð»Ð°Ð³ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°

        const TIMEOUT_MS = 5000;
        let inactivityTimer;

        function resetTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                console.log("No data received. Closing stream.");
                shutdown();
            }, TIMEOUT_MS);
        }

        function shutdown() {
            try {
                ws.close();
            } catch (e) { }

            try {
                if (ms.readyState === "open") {
                    ms.endOfStream();
                }
            } catch (e) { }

            video.pause();
        }

        const ws = new WebSocket("ws://localhost:8080/stream");
        ws.binaryType = "arraybuffer";

        ws.onmessage = (event) => {
            resetTimer();  // ðŸ’¡ ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€

            const payload = new Uint8Array(event.data);
            queue.push(payload);
            feed();

            // ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð²Ð¸Ð´ÐµÐ¾ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð¿Ð°ÐºÐµÑ‚Ðµ
            if (!started) {
                started = true;
                video.play().catch(err => {
                    console.warn("Autoplay failed:", err);
                });
            }
        };

        ms.addEventListener("sourceopen", () => {
            sourceBuffer = ms.addSourceBuffer('video/webm; codecs="vp8"');

            // ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ Ð¿Ñ€Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸ update
            sourceBuffer.addEventListener("updateend", feed);
        });

        function feed() {
            if (!queue.length || sourceBuffer.updating) return;
            sourceBuffer.appendBuffer(queue.shift());
        }

        // ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸ Ð¸ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
        const MAX_QUEUE = 50; // Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ Ñ‡Ð°Ð½ÐºÐ¾Ð²
        setInterval(() => {
            if (!sourceBuffer || sourceBuffer.updating) return;
            // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð±ÑƒÑ„ÐµÑ€Ñ‹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð·Ð°ÑÐ¾Ñ€ÑÑ‚ÑŒ Ð¿Ð°Ð¼ÑÑ‚ÑŒ
            const current = video.currentTime;
            if (current > 2) {
                try {
                    sourceBuffer.remove(0, current - 2);
                } catch (e) {
                    console.warn("Remove failed:", e);
                }
            }
            if (queue.length > MAX_QUEUE) {
                queue.splice(0, queue.length - MAX_QUEUE);
            }
        }, 2000);
    </script>
</body>

</html>
